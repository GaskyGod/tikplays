<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Overlay: Guerra de regalos v2</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{
      --left:#ef4444;
      --right:#60a5fa;
      --accent:#f59e0b;
      --radius:20px;
      --bg: rgba(0,0,0,.45);
      --chip: rgba(255,255,255,.10);
      --text:#fff;
      --muted: rgba(255,255,255,.85);
      --shadow: 0 2px 8px rgba(0,0,0,.45), 0 0 1px rgba(255,255,255,.07) inset;
      --tile:44px;               /* << tamaño de la ficha de cada regalo */
    }
    html,body{height:100%;margin:0}
    body{
      display:flex;align-items:center;justify-content:center;
      background:transparent;color:var(--text);
      font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;
    }
    .card{
      background: var(--bg);
      border:1px solid rgba(255,255,255,.12);
      border-radius: var(--radius);
      padding: 14px 18px;
      min-width: 560px;
      max-width: 92vw;
      box-sizing: border-box;
      position: relative;
      backdrop-filter: blur(2px);
    }

    .row{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:18px}
    .col{display:flex;flex-direction:column;align-items:center;gap:8px}

    .gifts{
      display:flex;gap:6px;flex-wrap:wrap;justify-content:center;
      min-height: var(--tile);
      align-content:center;
    }

    /* Cuadrito fijo (modo grid) */
    .gift{
      width:var(--tile); height:var(--tile); border-radius:10px;
      background: var(--chip); box-shadow: var(--shadow);
      display:grid;place-items:center; overflow:hidden; position:relative;
    }
    .gift img{
      width:100% !important; height:100% !important;
      object-fit:cover !important; display:block;
    }

    /* Rotador apilado (modo rotate) — mismo tamaño de ficha */
    .rotator{position:relative;width:var(--tile);height:var(--tile)}
    .rotator img{
      position:absolute; inset:0; object-fit:cover !important;
      width:100% !important; height:100% !important;
      border-radius:10px; opacity:0; transition:opacity .35s ease, transform .35s ease;
      background: var(--chip); box-shadow: var(--shadow);
      transform: scale(.96); pointer-events:none;
    }
    .rotator img.show{ opacity:1; transform:scale(1); pointer-events:auto; }

    .score{
      font-weight:900;font-size:52px;line-height:1;
      text-shadow:0 3px 10px rgba(0,0,0,.55);
      border-radius:12px; padding:4px 12px; background: rgba(255,255,255,.08);
    }
    .score.left{box-shadow:0 0 0 3px color-mix(in srgb, var(--left) 40%, transparent)}
    .score.right{box-shadow:0 0 0 3px color-mix(in srgb, var(--right) 40%, transparent)}

    .vs{
      font-weight:900;font-size:40px;letter-spacing:1px;
      color:var(--accent);
      text-shadow:0 2px 8px rgba(0,0,0,.55),0 0 8px color-mix(in srgb, var(--accent) 45%, transparent);
      padding:4px 12px;border-radius:12px;background: rgba(255,255,255,.06);
      box-shadow: var(--shadow);
    }

    .footer{
      margin-top:10px;display:flex;justify-content:center;gap:8px;align-items:center;
      font-weight:800;font-size:18px;color:var(--muted);
      text-shadow:0 2px 4px rgba(0,0,0,.5);
    }
    .tag{
      padding:4px 10px;border-radius:999px;background:var(--chip);
      box-shadow: var(--shadow); font-weight:700
    }
    .tag.left{outline:2px solid color-mix(in srgb, var(--left) 50%, transparent)}
    .tag.right{outline:2px solid color-mix(in srgb, var(--right) 50%, transparent)}
    .tag.tie{outline:2px solid rgba(255,255,255,.18)}

    /* Countdown flotante (solo si lidera IZQUIERDA) */
    .cd{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      font-weight:900;letter-spacing:.5px;
      font-size:68px;line-height:1;display:none;
      color:#fff;text-shadow:0 6px 24px rgba(0,0,0,.7), 0 0 12px color-mix(in srgb, var(--accent) 40%, transparent);
    }
    .cd.show{display:block}
    .cd.lost{font-size:56px;color:#ffd166}
  </style>
</head>
<body>
  <div class="card">
    <div class="row">
      <div class="col">
        <div class="gifts" id="giftsL"></div>
        <div class="score left" id="scoreL">0</div>
      </div>

      <div class="vs">VS</div>

      <div class="col">
        <div class="gifts" id="giftsR"></div>
        <div class="score right" id="scoreR">0</div>
      </div>
    </div>

    <div class="footer">
      <span class="tag tie" id="footerTag">EMPATE</span>
      <span class="tag" id="footerLead" style="display:none;"></span>
      <span class="tag" id="footerCD"   style="display:none;"></span>
    </div>

    <div class="cd" id="cd"></div>
  </div>

  <script>
    const socket = io();
    const $ = (s) => document.querySelector(s);
    const q = new URLSearchParams(location.search);

    // Custom por query
    if (q.get('left'))    document.documentElement.style.setProperty('--left',  q.get('left'));
    if (q.get('right'))   document.documentElement.style.setProperty('--right', q.get('right'));
    if (q.get('accent'))  document.documentElement.style.setProperty('--accent',q.get('accent'));
    if (q.get('bg'))      document.documentElement.style.setProperty('--bg',    q.get('bg'));
    if (q.get('rounded')) document.documentElement.style.setProperty('--radius', q.get('rounded')+'px');
    if (q.get('tile'))    document.documentElement.style.setProperty('--tile',   (parseInt(q.get('tile'),10)||44)+'px');

    // Estado
    let catalog = {};
    let left=0, right=0;
    let leftGifts=[], rightGifts=[];
    let displayMode = 'grid';       // 'grid' | 'rotate'
    let displayIntervalMs = 1200;   // rotación

    // Countdown SOLO para la izquierda
    let prevLeader = null;  let endAt = 0;  let lostLock = false;  let rafId = null;
    let leadCountdown = Math.max(3, parseInt(q.get('cd')||'10',10) || 10);

    const fmt = (sec)=>{
      sec = Math.max(0, Math.floor(sec));
      const m = Math.floor(sec/60), s = sec%60;
      return (m>0 ? String(m).padStart(2,'0')+':' : '') + String(s).padStart(2,'0');
    };

    function startRaf(){
      if (rafId) cancelAnimationFrame(rafId);
      const step = ()=>{
        if (!endAt) return;
        const secs = (endAt - performance.now())/1000;
        if (secs <= 0){
          $('#cd').className = 'cd show lost';
          $('#cd').textContent = '¡Perdiste!';
          $('#footerCD').style.display = 'none';
          lostLock = true; endAt = 0; return;
        }
        $('#cd').className = 'cd show';
        $('#cd').textContent = fmt(secs);
        $('#footerCD').style.display = '';
        $('#footerCD').textContent = Math.ceil(secs)+'s';
        rafId = requestAnimationFrame(step);
      };
      rafId = requestAnimationFrame(step);
    }
    function stopCountdown(){
      endAt = 0;
      $('#cd').classList.remove('show','lost'); $('#cd').textContent = '';
      $('#footerCD').style.display = 'none';
      if (rafId) cancelAnimationFrame(rafId); rafId = null;
    }

    // ---- gifts ----
    let rotTimerL=null, rotTimerR=null;
    function clearRotators(){
      if (rotTimerL) { clearInterval(rotTimerL); rotTimerL=null; }
      if (rotTimerR) { clearInterval(rotTimerR); rotTimerR=null; }
    }

    function renderGiftsGrid(container, ids){
      const el = $(container); el.innerHTML = '';
      ids.slice(0,3).forEach(id=>{
        const g = catalog[id]||{};
        const div = document.createElement('div');
        div.className = 'gift';
        if (g.image){
          const img = document.createElement('img');
          img.src = g.image; img.alt = g.name || 'gift';
          div.appendChild(img);
        } else {
          div.textContent = id; div.style.fontSize='12px';
        }
        el.appendChild(div);
      });
    }

    function renderGiftsRotate(container, ids, which){
      const el = $(container); el.innerHTML = '';
      const imgs = ids.slice(0,3).map(id => (catalog[id]||{}).image).filter(Boolean);
      if (!imgs.length) return;

      const wrap = document.createElement('div'); wrap.className='rotator';
      imgs.forEach((src,i)=>{
        const im = document.createElement('img'); im.src = src; im.alt = 'gift';
        if (i===0) im.classList.add('show');
        wrap.appendChild(im);
      });
      el.appendChild(wrap);

      if (imgs.length <= 1) return;
      let idx=0;
      const tick=()=>{
        const list=[...wrap.querySelectorAll('img')];
        list[idx]?.classList.remove('show');
        idx = (idx+1)%list.length;
        list[idx]?.classList.add('show');
      };
      const t = setInterval(tick, Math.max(600, displayIntervalMs|0));
      if (which==='L') rotTimerL=t; else rotTimerR=t;
    }

    function updateFooter(){
      const tag = $('#footerTag'); const lead = $('#footerLead');
      if (left === right){
        tag.textContent = 'EMPATE'; tag.className = 'tag tie';
        lead.style.display = 'none'; stopCountdown(); lostLock=false; prevLeader=null; return;
      }
      const diff = Math.abs(left-right);
      if (left > right){ tag.textContent = 'IZQUIERDA'; tag.className = 'tag left';  lead.textContent = `+${diff}`; lead.style.display = ''; }
      else { tag.textContent = 'DERECHA'; tag.className = 'tag right'; lead.textContent = `+${diff}`; lead.style.display = ''; }
    }

    function render(){
      $('#scoreL').textContent = left|0;
      $('#scoreR').textContent = right|0;

      clearRotators();
      if (displayMode === 'rotate'){
        renderGiftsRotate('#giftsL', leftGifts, 'L');
        renderGiftsRotate('#giftsR', rightGifts, 'R');
      } else {
        renderGiftsGrid('#giftsL', leftGifts);
        renderGiftsGrid('#giftsR', rightGifts);
      }

      updateFooter();

      // contador solo si gana izquierda
      const nowLeader = left>right ? 'left' : (right>left ? 'right' : null);
      if (nowLeader !== 'left' || (left===0 && right===0)) { lostLock=false; }
      if (lostLock){ $('#cd').className='cd show lost'; $('#cd').textContent='¡Perdiste!'; return; }

      if (nowLeader === 'left'){
        if (prevLeader !== 'left' || endAt === 0){
          const secs = Math.max(3, leadCountdown);
          endAt = performance.now() + secs*1000;
          startRaf();
        }
      } else { stopCountdown(); }

      prevLeader = nowLeader;
    }

    // sockets
    socket.on('giftCatalog', (c)=>{ catalog = c||{}; render(); });
    socket.on('giftBattle', (s)=>{
      left  = Math.max(0, parseFloat(s?.leftPoints  ?? s?.left?.points  ?? 0) || 0);
      right = Math.max(0, parseFloat(s?.rightPoints ?? s?.right?.points ?? 0) || 0);
      if (s?.leadCountdown) leadCountdown = Math.max(3, parseInt(s.leadCountdown,10) || leadCountdown);
      leftGifts  = s?.left?.gifts  || [];
      rightGifts = s?.right?.gifts || [];
      if (s?.display?.mode)        displayMode = (s.display.mode==='rotate'?'rotate':'grid');
      if (s?.display?.intervalMs)  displayIntervalMs = Math.max(400, parseInt(s.display.intervalMs,10) || displayIntervalMs);
      if (left===0 && right===0){ stopCountdown(); lostLock=false; prevLeader=null; }
      render();
    });

    render();
  </script>
</body>
</html>
