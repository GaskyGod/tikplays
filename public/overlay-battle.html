<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Overlay: Guerra de regalos</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{
      --left:#ef4444;   /* rojo */
      --right:#60a5fa;  /* azul */
      --radius:20px;
    }
    html,body{height:100%;margin:0}
    body{
      display:flex;align-items:center;justify-content:center;
      background:transparent;
      font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;
      color:#fff;
    }
    .card{
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.12);
      border-radius: var(--radius);
      padding: 16px 18px;
      min-width: 640px;
      max-width: 90vw;
      box-sizing: border-box;
      position: relative;
    }
    .row{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:8px}
    .title{font-weight:800;text-shadow:0 2px 4px rgba(0,0,0,.4)}
    .score{font-weight:800;font-size:22px;text-shadow:0 2px 4px rgba(0,0,0,.4)}
    .bar{
      position:relative;height:12px;border-radius:999px;overflow:hidden;
      background: rgba(255,255,255,.18);
    }
    /* pintamos el lado derecho completo y sobre él el izquierdo (ancho variable) */
    .fill-right{position:absolute;inset:0;background:var(--right)}
    .fill-left{position:absolute;inset:0;width:0;background:var(--left)}
    .hint{
      margin-top:8px;font-size:20px;opacity:.9;text-shadow:0 2px 4px rgba(0,0,0,.4)
    }
    /* contador gigante centrado */
    .countdown{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      font-weight:900;letter-spacing:1px;
      font-size:72px;line-height:1;
      text-shadow:0 4px 16px rgba(0,0,0,.65), 0 0 4px rgba(0,0,0,.6);
      display:none;
    }
    .countdown.show{display:block}
    .lost{font-size:56px;color:#ffd166}
  </style>
</head>
<body>
  <div class="card" id="card">
    <div class="row">
      <div class="title" id="tLeft">Me reinicias</div>
      <div class="score" id="sLeft">0</div>
      <div class="score" id="sRight">0</div>
      <div class="title" id="tRight">Me salvas</div>
    </div>
    <div class="bar">
      <div class="fill-right" id="barRight"></div>
      <div class="fill-left"  id="barLeft"></div>
    </div>
    <div class="hint" id="hint">Empate</div>

    <!-- Contador grande centrado -->
    <div class="countdown" id="cd"></div>
  </div>

  <script>
    const socket = io();
    const $ = s => document.querySelector(s);

    // Colores opcionales por query: ?left=%23ff3366&right=%2300d1ff&rounded=24&cd=10
    const q = new URLSearchParams(location.search);
    if (q.get('left'))  document.documentElement.style.setProperty('--left',  q.get('left'));
    if (q.get('right')) document.documentElement.style.setProperty('--right', q.get('right'));
    if (q.get('rounded')) document.documentElement.style.setProperty('--radius', q.get('rounded')+'px');

    let defCountdown = Math.max(3, parseInt(q.get('cd')||'0',10) || 0) || 10;

    // Estado que llega del server (si tu módulo lo emite con otro nombre, ajusta aquí)
    let cfg = {
      titleLeft: 'Me reinicias',
      titleRight: 'Me salvas',
      leadCountdown: defCountdown
    };
    let left = 0, right = 0;

    // Lógica de contador en cliente (solo cuando gana la izquierda)
    let prevLeader = null;       // 'left' | 'right' | null
    let endAt = 0;               // timestamp ms de final del conteo
    let lostLock = false;        // para mostrar "¡Perdiste!" hasta que cambie la situación
    let rafId = null;

    function fmt(sec){
      sec = Math.max(0, Math.floor(sec));
      const m = Math.floor(sec/60), s = sec%60;
      return (m>0 ? String(m).padStart(2,'0')+':' : '') + String(s).padStart(2,'0');
    }

    function startRaf(){
      if (rafId) cancelAnimationFrame(rafId);
      const step = () => {
        if (!endAt) return; // no contando
        const secs = (endAt - performance.now())/1000;
        if (secs <= 0) {
          $('#cd').className = 'countdown show lost';
          $('#cd').textContent = '¡Perdiste!';
          lostLock = true;
          endAt = 0;
          return; // detenemos hasta que cambie el estado
        }
        $('#cd').className = 'countdown show';
        $('#cd').textContent = fmt(secs);
        rafId = requestAnimationFrame(step);
      };
      rafId = requestAnimationFrame(step);
    }

    function stopCountdown(resetToCfg = true){
      endAt = 0;
      if (resetToCfg) cfg.leadCountdown = cfg.leadCountdown || defCountdown;
      $('#cd').classList.remove('show','lost');
      $('#cd').textContent = '';
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;
    }

    function leaderOf(l, r){
      if (l > r) return 'left';
      if (r > l) return 'right';
      return null;
    }

    function render(){
      // títulos y puntajes
      $('#tLeft').textContent  = cfg.titleLeft  || 'Me reinicias';
      $('#tRight').textContent = cfg.titleRight || 'Me salvas';
      $('#sLeft').textContent  = left|0;
      $('#sRight').textContent = right|0;

      // porcentaje (0-0 -> 50/50)
      const total = (left + right);
      const leftPct = total === 0 ? 50 : (left * 100 / total);
      $('#barLeft').style.width  = Math.max(0, Math.min(100, leftPct)) + '%';

      // ventaja texto
      const diff = Math.abs(left - right);
      const lead = leaderOf(left, right);
      if (lead === 'left') {
        $('#hint').textContent = `Reinicias con ventaja de ${diff} punto${diff===1?'':'s'}`;
      } else if (lead === 'right') {
        $('#hint').textContent = `Salvas con ventaja de ${diff} punto${diff===1?'':'s'}`;
      } else {
        $('#hint').textContent = 'Empate';
      }

      // lógica de contador (solo si lidera la izquierda)
      const nowLeader = lead;

      // desbloqueo del "Perdiste" si deja de liderar la izquierda o si 0-0
      if (nowLeader !== 'left' || (left===0 && right===0)) {
        lostLock = false;
      }

      if (lostLock) {
        // seguimos mostrando "¡Perdiste!" hasta que cambie la situación
        $('#cd').className = 'countdown show lost';
        $('#cd').textContent = '¡Perdiste!';
        return;
      }

      if (nowLeader === 'left') {
        // si antes no lideraba la izquierda, o cambió el marcador, reiniciamos conteo
        if (prevLeader !== 'left' || endAt === 0) {
          const secs = Math.max(3, (cfg.leadCountdown || defCountdown));
          endAt = performance.now() + secs * 1000;
          startRaf();
        }
        // mostrar si aún estamos contando
        if (endAt > 0) $('#cd').classList.add('show');
      } else {
        // derecha gana o empate => reset total del contador
        stopCountdown(true);
      }

      prevLeader = nowLeader;
    }

    // Socket: estado de batalla
    socket.on('giftBattle', (s) => {
      // campos esperados (si faltan, usamos defaults)
      left  = Math.max(0, parseFloat(s?.leftPoints ?? s?.left?.points ?? 0) || 0);
      right = Math.max(0, parseFloat(s?.rightPoints?? s?.right?.points?? 0) || 0);
      if (s?.titleLeft)  cfg.titleLeft  = s.titleLeft;
      if (s?.titleRight) cfg.titleRight = s.titleRight;
      if (s?.leadCountdown) cfg.leadCountdown = s.leadCountdown;

      // si el server manda un reset (0–0), limpiar todo
      if (left===0 && right===0){
        stopCountdown();
        lostLock = false;
        prevLeader = null;
      }
      render();
    });

    // Render inicial por si tarda en llegar el primer estado
    cfg.leadCountdown = defCountdown;
    render();
  </script>
</body>
</html>
